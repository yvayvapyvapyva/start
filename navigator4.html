<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Route Navigator Optimized</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU&suppressMapOpenBlock=true"></script>
    <style>
        :root { --bg: var(--tg-theme-bg-color, #f5f5f7); --btn: var(--tg-theme-button-color, #007AFF); --btn-txt: var(--tg-theme-button-text-color, #fff); --sheet-bg: rgba(255, 255, 255, 0.95); --text-main: #1d1d1f; --text-sub: #86868b; --accent: #007AFF; --border: rgba(255,255,255,0.1); --panel-blur: blur(15px); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: #000; position: fixed; touch-action: none; }
        #map { position: absolute; inset: 0; z-index: 1; touch-action: auto; }
        [class*="-copyrights-pane"], [class*="-map-copyrights-promo"], [class*="-controls-pane"] { display: none !important; }
        
        .top-controls { position: absolute; top: 16px; right: 16px; z-index: 9005; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .icon-btn { pointer-events: auto; width: 48px; height: 48px; border-radius: 14px; background: rgba(0,0,0,.75); border: 1px solid rgba(255,255,255,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: var(--panel-blur); }
        .icon-btn svg { fill: white; width: 24px; }

        .bottom-ui-wrapper { position: absolute; bottom: 30px; left: 16px; right: 16px; z-index: 9000; display: flex; align-items: flex-end; justify-content: flex-end; gap: 12px; pointer-events: none; }
        #navHud, #selectionHud { flex: 1; background: rgba(0,0,0,0.85); backdrop-filter: var(--panel-blur); border-radius: 18px; padding: 14px; color: white; display: none; flex-direction: column; gap: 6px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.4); pointer-events: auto; max-width: calc(100% - 80px); }
        #navHud.active, #selectionHud.active { display: flex; }
        
        .hud-actions { display: flex; gap: 8px; margin-top: 8px; }
        .hud-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; background: var(--btn); color: white; font-weight: 700; font-size: 13px; cursor: pointer; }
        
        .control-stack { display: flex; flex-direction: column; gap: 10px; width: 52px; pointer-events: none; }
        #telemetryHud { background: rgba(0,0,0,0.85); backdrop-filter: var(--panel-blur); border-radius: 14px; padding: 8px 0; color: white; display: flex; flex-direction: column; align-items: center; border: 1px solid var(--border); pointer-events: auto; }
        .tel-item { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .tel-label { font-size: 7px; color: #aaa; font-weight: 700; }
        .tel-value { font-size: 14px; font-weight: 800; }
        
        .map-btn { pointer-events: auto; width: 52px; height: 52px; border-radius: 50%; background: rgba(0,0,0,.75); border: 1px solid rgba(255,255,255,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .map-btn svg { fill: white; width: 24px; }
        .map-btn.active { background: var(--btn); }

        .loading-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        
        #filterMenu { position: absolute; bottom: 60px; right: 0; pointer-events: auto; background: var(--sheet-bg); border-radius: 20px; display: none; flex-direction: column; border: 1px solid rgba(0,0,0,0.15); min-width: 280px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        #pointsList { max-height: 60vh; overflow-y: auto; padding: 8px; }
        .point-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; color: black; font-weight: 600; cursor: pointer; }
        .source-select { width: 100%; padding: 10px; border: none; background: #f0f0f2; font-weight: bold; border-radius: 10px; margin-bottom: 5px; }
    </style>
</head>
<body onclick="activateNoSleep()">

<div id="loading" class="loading-overlay">Инициализация...</div>
<!-- Элемент для NoSleep (скрытое видео) -->
<video id="noSleepVideo" playsinline loop muted style="display:none"></video>

<div id="map"></div>

<div class="top-controls">
    <div class="icon-btn" onclick="toggleSettings();">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
    </div>
</div>

<div class="bottom-ui-wrapper">
    <div id="navHud">
        <div style="display:flex; align-items:center; gap:8px">
            <span id="hudIndex" style="background:var(--accent); color:white; padding:2px 6px; border-radius:5px; font-size:10px">1</span>
            <div id="hudCmd" style="font-weight:700">Загрузка...</div>
        </div>
        <div style="display:flex; gap:15px; margin-top:5px; font-size:13px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px">
            <div><span style="color:#aaa">ДИСТ:</span> <span id="hudDist">---</span></div>
            <div><span style="color:#aaa">АЗ:</span> <span id="hudTargetAz">---</span></div>
        </div>
    </div>

    <div id="selectionHud">
        <div style="font-weight:700" id="selCmd">Выбранная точка</div>
        <div class="hud-actions">
            <button class="hud-btn" id="selConfirmBtn">Сделать целью</button>
        </div>
    </div>

    <div class="control-stack">
        <div id="telemetryHud">
            <div class="tel-item"><span class="tel-label">КМ/Ч</span><span class="tel-value" id="telSpeed">0</span></div>
            <div class="tel-item"><span class="tel-label">АЗ</span><span class="tel-value" id="telAz">0°</span></div>
        </div>
        <div style="position:relative">
            <div class="map-btn" onclick="toggleMenu(); event.stopPropagation();"><svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg></div>
            <div id="filterMenu" onclick="event.stopPropagation()">
                <div style="padding:10px">
                    <select id="sourceSelect" class="source-select" onchange="loadData(this.value); toggleMenu(false);"><option value="" disabled selected>Выберите маршрут...</option></select>
                </div>
                <div id="pointsList"></div>
            </div>
        </div>
        <div id="locateBtn" class="map-btn active" onclick="autoCenter=!autoCenter; this.classList.toggle('active', autoCenter);"><svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 7.48 7.94 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg></div>
    </div>
</div>

<script>
const CFG = { 
    USER_ID: "yvayvapyvapyva", 
    TRIGGER_DIST: 25, 
    SPEED_THRESHOLD: 3, 
    COLORS: { Gold:'#FFD700', Blue:'#007AFF', Red:'#FF3B30', Lime:'#34C759', Purple:'#AF52DE' } 
};

let map, objectManager, userMarker, pathsCollection, previewPathsCollection, pointsData=[], currentIndex=-1, autoCenter=true, lastPos=null, lastAz=0, wakeLock=null;

const ui = id => document.getElementById(id);

/**
 * ФУНКЦИЯ ПРОТИВ ЗАСЫПАНИЯ ЭКРАНА
 * Запускается по клику пользователя в любом месте
 */
async function activateNoSleep() {
    // Способ 1: Скрытое видео (для iOS/старых браузеров)
    const v = ui('noSleepVideo');
    if (v.paused) {
        v.src = 'https://raw.githubusercontent.com/anars/blank-audio/master/10-seconds-of-silence.mp3'; // Маленький файл-заглушка
        v.play().catch(() => {});
    }
    
    // Способ 2: Screen Wake Lock API (современные браузеры)
    if ('wakeLock' in navigator && !wakeLock) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => { wakeLock = null; });
        } catch (err) {}
    }
}

const calcAz = (p1, p2) => {
    const [la1, lo1] = p1.map(v => v * Math.PI/180), [la2, lo2] = p2.map(v => v * Math.PI/180);
    const y = Math.sin(lo2-lo1) * Math.cos(la2), x = Math.cos(la1)*Math.sin(la2) - Math.sin(la1)*Math.cos(la2)*Math.cos(lo2-lo1);
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
};

// Генерация иконок с кэшированием
const iconCache = new Map();
const getIcon = (col, txt, az, isEnd = false, isCurr = false) => {
    const key = `${col}-${txt}-${Math.round(az)}-${isEnd}-${isCurr}`;
    if(iconCache.has(key)) return iconCache.get(key);
    
    const size = isEnd ? 30 : 40;
    const center = size / 2;
    const stroke = isCurr ? '#34C759' : (isEnd ? 'white' : 'black');
    
    const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
        <g transform="rotate(${az},${center},${center})">
            <polygon points="${center},2 ${center+8},${size-5} ${center},${size-12} ${center-8},${size-5}" fill="${col}" stroke="${stroke}" stroke-width="2"/>
        </g>
        <circle cx="${center}" cy="${center}" r="${isEnd ? 6 : 9}" fill="${col}" stroke="${stroke}" stroke-width="1.5"/>
        <text x="${center}" y="${center+1}" font-size="${isEnd ? 7 : 9}" font-family="Arial" font-weight="900" text-anchor="middle" dominant-baseline="middle" fill="black" stroke="white" stroke-width="2" style="paint-order:stroke fill">${txt}</text>
    </svg>`;
    
    const res = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    iconCache.set(key, res);
    return res;
};

ymaps.ready(() => {
    map = new ymaps.Map("map", { center: [56.3268, 44.0059], zoom: 15, type: 'yandex#satellite', controls: [] });
    objectManager = new ymaps.ObjectManager();
    pathsCollection = new ymaps.GeoObjectCollection();
    previewPathsCollection = new ymaps.GeoObjectCollection();
    map.geoObjects.add(objectManager).add(pathsCollection).add(previewPathsCollection);
    
    userMarker = new ymaps.Placemark(map.getCenter(), {}, { iconLayout:'default#image', iconImageSize:[40,40], iconImageOffset:[-20,-20] });
    map.geoObjects.add(userMarker);

    objectManager.events.add('click', e => {
        const id = e.get('objectId');
        const p = pointsData.find(x => x.id === id);
        if(!p) return;
        
        ui('navHud').classList.remove('active');
        ui('selectionHud').classList.add('active');
        ui('selCmd').innerText = p.comment || `Точка ${p.id}`;
        ui('selConfirmBtn').onclick = () => { setTarget(pointsData.indexOf(p)); closeSelection(); };
        
        // Отрисовка пути предпросмотра с меткой в конце
        previewPathsCollection.removeAll();
        if(p.paths) {
            p.paths.forEach(ps => {
                if(!ps.pts || ps.pts.length < 2) return;
                previewPathsCollection.add(new ymaps.Polyline(ps.pts, {}, {strokeColor:p.hex, strokeWidth:4, strokeOpacity:0.5}));
                
                // Метка в конце предпросмотра
                const lastIdx = ps.pts.length - 1;
                const endAz = calcAz(ps.pts[lastIdx-1], ps.pts[lastIdx]);
                previewPathsCollection.add(new ymaps.Placemark(ps.pts[lastIdx], {}, {
                    iconLayout: 'default#image',
                    iconImageHref: getIcon(p.hex, String(p.id), endAz, true),
                    iconImageSize: [30, 30], iconImageOffset: [-15, -15]
                }));
            });
        }
    });

    map.events.add('click', () => { closeSelection(); toggleMenu(false); });

    navigator.geolocation.watchPosition(p => {
        const c = [p.coords.latitude, p.coords.longitude], speed = p.coords.speed ? p.coords.speed*3.6 : 0;
        if(speed >= CFG.SPEED_THRESHOLD) lastAz = p.coords.heading ?? (lastPos ? calcAz(lastPos, c) : lastAz);
        lastPos = c; 
        userMarker.geometry.setCoordinates(c);
        userMarker.options.set('iconImageHref', `data:image/svg+xml;base64,${btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><g transform="rotate(${lastAz},20,20)"><path d="M20,4 L32,34 L20,28 L8,34 Z" fill="#FF3B30" stroke="white" stroke-width="2"/></g></svg>`)}`);
        ui('telSpeed').innerText = Math.round(speed);
        ui('telAz').innerText = `${Math.round(lastAz)}°`;
        if(autoCenter) map.panTo(c);
        checkNav();
    }, null, {enableHighAccuracy:true});

    fetchGists();
    ui('loading').classList.add('hidden');
});

function closeSelection() { ui('selectionHud').classList.remove('active'); previewPathsCollection.removeAll(); if(currentIndex >= 0) ui('navHud').classList.add('active'); }

async function fetchGists() {
    try {
        const res = await fetch(`https://api.github.com/users/${CFG.USER_ID}/gists`);
        const data = await res.json();
        const select = ui('sourceSelect');
        data.forEach(g => {
            Object.values(g.files).forEach(f => {
                if(f.filename.endsWith('.json')) {
                    const opt = new Option(f.filename.replace('.json',''), f.raw_url);
                    select.add(opt);
                }
            });
        });
    } catch(e) {}
}

async function loadData(url) {
    ui('loading').classList.remove('hidden');
    try {
        const res = await fetch(url);
        pointsData = (await res.json()).map(d => ({ ...d, hex: CFG.COLORS[d.color] || d.color || '#007AFF' }));
        currentIndex = 0;
        refreshMap();
        ui('navHud').classList.add('active');
    } catch(e) {}
    ui('loading').classList.add('hidden');
}

function refreshMap() {
    objectManager.removeAll();
    pathsCollection.removeAll();
    
    const curr = pointsData[currentIndex];
    objectManager.add(pointsData.map((p, i) => ({
        type:'Feature', id:p.id, geometry:{type:'Point', coordinates:[p.lat, p.lon]},
        options:{ 
            iconLayout:'default#image', 
            iconImageHref:getIcon(p.hex, String(p.id), p.az||0, false, i===currentIndex), 
            iconImageSize:[40,40], iconImageOffset:[-20,-20],
            opacity: i < currentIndex ? 0.3 : 1.0
        }
    })));

    // Отрисовка текущего пути и меток конца пути
    if(curr && curr.paths) {
        curr.paths.forEach(ps => {
            if(!ps.pts || ps.pts.length < 2) return;
            pathsCollection.add(new ymaps.Polyline(ps.pts, {}, {strokeColor:curr.hex, strokeWidth:5, strokeOpacity:0.8}));
            
            // МЕТКА В КОНЦЕ ПУТИ
            const lastIdx = ps.pts.length - 1;
            const endAz = calcAz(ps.pts[lastIdx-1], ps.pts[lastIdx]);
            pathsCollection.add(new ymaps.Placemark(ps.pts[lastIdx], {}, {
                iconLayout: 'default#image',
                iconImageHref: getIcon(curr.hex, String(curr.id), endAz, true),
                iconImageSize: [30, 30], iconImageOffset: [-15, -15]
            }));
        });
    }
}

function checkNav() {
    if(!lastPos || currentIndex < 0) return;
    const curr = pointsData[currentIndex];
    const dist = ymaps.coordSystem.geo.getDistance(lastPos, [curr.lat, curr.lon]);
    
    ui('hudIndex').innerText = currentIndex + 1;
    ui('hudCmd').innerText = curr.comment || `Точка ${curr.id}`;
    ui('hudDist').innerText = dist > 1000 ? (dist/1000).toFixed(1)+'км' : Math.round(dist)+'м';
    ui('hudTargetAz').innerText = Math.round(calcAz(lastPos, [curr.lat, curr.lon])) + '°';

    if(dist < CFG.TRIGGER_DIST) {
        if(currentIndex < pointsData.length - 1) {
            currentIndex++;
            refreshMap();
        }
    }
}

function setTarget(idx) { currentIndex = idx; refreshMap(); }
function toggleMenu(s) { const m = ui('filterMenu'); m.style.display = (s === undefined ? m.style.display !== 'flex' : s) ? 'flex' : 'none'; }
function toggleSettings() {} // Пустая заглушка если нет логики
</script>

</body>
</html>