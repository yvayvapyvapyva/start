<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Route Editor Pro | Welcome</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU&suppressMapOpenBlock=true"></script>
    <style>
        :root { --btn: #007AFF; --text: #1d1d1f; --danger: #FF3B30; --success: #34C759; --radius: 24px; --border: rgba(0,0,0,0.1); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: #f5f5f7; -webkit-tap-highlight-color: transparent; }
        #map { position: absolute; inset: 0; z-index: 1; display: none; }
        [class*="-copyrights-pane"], [class*="-controls-pane"] { display: none !important; }
        
        /* Welcome Screen */
        #welcomeScreen { position: fixed; inset: 0; z-index: 5000; background: #f5f5f7; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .welcome-card { background: #fff; width: 100%; max-width: 400px; padding: 32px; border-radius: 32px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); text-align: center; }
        .welcome-card h2 { margin-bottom: 24px; font-weight: 800; color: var(--text); }
        .welcome-btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--btn); color: #fff; }
        .btn-secondary { background: #f0f0f2; color: var(--text); }
        
        /* Main Controls */
        .bottom-center-controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; display: none; }
        .btn-add-main { background: var(--btn); color: #fff; padding: 14px 28px; border-radius: 30px; font-weight: 600; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.4); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 16px; transition: 0.2s; white-space: nowrap; }
        .btn-add-main.active { background: var(--danger); }
        .btn-add-main.drawing { background: var(--success); }
        
        #saveBtn.loading { background: #e5e5ea !important; color: #8e8e93 !important; pointer-events: none; }
        #saveBtn.saved { background: var(--success) !important; color: #fff !important; }
        
        /* Modals */
        .modal { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
        .modal-content { background: #fff; width: 100%; max-width: 440px; border-radius: var(--radius); display: flex; flex-direction: column; max-height: 85vh; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .btn-action { background: var(--btn); color: #fff; border: none; border-radius: 14px; padding: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; flex: 1; }
        .btn-action.danger { background: rgba(255, 59, 48, 0.1); color: var(--danger); }
        
        .editor-section { padding: 20px; overflow-y: auto; }
        input, textarea, select { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; margin-bottom: 12px; background: #f9f9fb; font-family: inherit; }
        
        .gist-list { max-height: 400px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 16px; padding: 8px; background: #f9f9fb; }
        .gist-item { padding: 14px; border-radius: 12px; background: #fff; margin-bottom: 8px; border: 1px solid var(--border); cursor: pointer; text-align: left; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .gist-item:hover { background: #eef7ff; border-color: var(--btn); }
        .gist-info { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .gist-item strong { font-size: 15px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .gist-item small { font-size: 11px; color: #8e8e93; margin-top: 4px; }
        
        .btn-delete-file { width: 40px; height: 40px; border-radius: 10px; border: none; background: transparent; color: #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .btn-delete-file:hover { background: rgba(255, 59, 48, 0.1); color: var(--danger); }
        
        .color-preview-circle { width: 44px; height: 44px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; }
        .color-dropdown { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 28px; padding: 12px; display: none; flex-direction: column; gap: 4px; z-index: 6000; box-shadow: 0 30px 100px rgba(0,0,0,0.5); width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .dropdown-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 5999; display: none; backdrop-filter: blur(2px); }
        .color-row { display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 18px; cursor: pointer; }
        .color-row:hover { background: #f5f5f7; }
        .swatch { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; border: 2px solid rgba(0,0,0,0.05); }
        .color-label { font-size: 16px; font-weight: 600; color: var(--text); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        label { display: block; font-size: 12px; font-weight: 700; text-transform: uppercase; color: #8e8e93; margin: 0 0 6px 4px; }
        .fab-mini { width: 40px; height: 40px; border-radius: 20px; background: #f0f0f2; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    </style>
</head>
<body>

<div id="welcomeScreen">
    <div class="welcome-card" id="welcomeMain">
        <h2>–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã</h2>
        <input type="password" id="ghTokenWelcome" placeholder="GitHub Token" style="margin-bottom: 20px;">
        <button class="welcome-btn btn-primary" onclick="showNewRouteInput()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç</button>
        <button class="welcome-btn btn-secondary" onclick="showGistList()">üìÇ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π</button>
    </div>
    
    <div class="welcome-card" id="newRouteForm" style="display: none;">
        <h2>–ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç</h2>
        <input type="text" id="newRouteName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (–±–µ–∑ .json)">
        <button class="welcome-btn btn-primary" onclick="handleCreateNew()">–°–æ–∑–¥–∞—Ç—å –∏ –Ω–∞—á–∞—Ç—å</button>
        <button class="welcome-btn btn-secondary" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
    </div>

    <div class="welcome-card" id="editRouteList" style="display: none;">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</h2>
        <div id="gistListContainer" class="gist-list"></div>
        <button class="welcome-btn btn-secondary" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
    </div>
</div>

<div id="map"></div>
<div class="bottom-center-controls" id="bottomControls">
    <button id="addMarkerBtn" class="btn-add-main" onclick="handleAddBtnClick()">
        <span id="addIcon" style="font-size:24px">+</span><span id="addText">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</span>
    </button>
    <button id="saveBtn" class="btn-add-main" style="margin-left:10px; background:#fff; color:var(--text)" onclick="saveGist()">
        <span id="saveIcon">üíæ</span> <span id="saveText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
    </button>
</div>

<div id="dropdownOverlay" class="dropdown-overlay" onclick="closeD()"></div>

<!-- Modals -->
<div id="createPointModal" class="modal" onclick="if(event.target===this) toggleM('createPointModal')">
    <div class="modal-content">
        <div class="modal-header"><h3>–ù–æ–≤–∞—è —Ç–æ—á–∫–∞</h3><div id="newColorBtn" class="color-preview-circle" onclick="toggleD('newColorDropdown')"></div><button class="fab-mini" onclick="toggleM('createPointModal')">‚úï</button></div>
        <div class="editor-section">
            <label>–ö–æ–º–∞–Ω–¥–∞</label>
            <select id="newCmdSelect"></select>
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea id="newComm" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
            <button class="btn-action" style="background:var(--success);width:100%" onclick="confirmP()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É</button>
        </div>
    </div>
</div>

<div id="editModal" class="modal" onclick="if(event.target===this) { applyChanges(); toggleM('editModal'); }">
    <div class="modal-content">
        <div class="modal-header"><h3 id="editTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><div id="editColorBtn" class="color-preview-circle" onclick="toggleD('editColorDropdown')"></div><button class="fab-mini" onclick="applyChanges(); toggleM('editModal')">‚úï</button></div>
        <div class="editor-section">
            <label>–ö–æ–º–∞–Ω–¥–∞</label>
            <select id="editCmdSelect" onchange="applyChanges()"></select>
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea id="editComm" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..." oninput="applyChanges()"></textarea>
            <div style="display:flex;gap:10px;margin-top:5px">
                <button class="btn-action" onclick="applyChanges(); startEditPath()">üõ§Ô∏è –ü—É—Ç—å</button>
                <button class="btn-action danger" onclick="delP()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div id="newColorDropdown" class="color-dropdown"></div>
<div id="editColorDropdown" class="color-dropdown"></div>

<script>
const $ = id => document.getElementById(id);
const f6 = n => Math.round(n * 1e6) / 1e6;

const COLORS = { 
    Gold: { hex: '#FFD700', label: '–ú–∞–Ω–µ–≤—Ä—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ' }, 
    Blue: { hex: '#007AFF', label: '–†–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞' }, 
    Red: { hex: '#FF3B30', label: '–†–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏' }, 
    Fuchsia: { hex: '#AF52DE', label: '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º' }, 
    Orange: { hex: '#FF9500', label: '–õ–µ–≤—ã–µ –∏ –ø—Ä–∞–≤—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã' }, 
    Purple: { hex: '#5856D6', label: '–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ –∏ –≥–∞—Ä–∞–∂' }, 
    Cyan: { hex: '#5AC8FA', label: '–†–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ' }, 
    Brown: { hex: '#A2845E', label: '–û—Å—Ç–∞–Ω–æ–≤–∫–∞' },
    Lime: { hex: '#34C759', label: '–ù–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è' }
};

const COMMAND_SETS = {
    Gold: ["–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ", "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –µ–¥–µ–º –ø—Ä—è–º–æ", "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ", "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç", "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã–π —Å—ä–µ–∑–¥", "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π —Å—ä–µ–∑–¥", "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç—Ä–µ—Ç–∏–π —Å—ä–µ–∑–¥", "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—ä–µ–∑–¥"],
    Blue: ["–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞", "–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–º –º–µ—Å—Ç–µ", "–ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ –∏ —Ä–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ—Å—å"],
    Red: ["–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏", "–ù–∞–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—á–∞—Å—Ç–∫–µ –¥–æ—Ä–æ–≥–∏", "–†–∞–∑–≥–æ–Ω—è–µ–º—Å—è –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏"],
    Fuchsia: ["–ü–æ –º–æ–µ–π –∫–æ–º–∞–Ω–¥–µ –≤—ã–ø–æ–ª–Ω–∏–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ", "–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ"],
    Orange: ["–ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–æ", "–ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞–ª–µ–≤–æ", "–î–∞–ª–µ–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ", "–î–∞–ª–µ–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ", "–ù–∞ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ", "–ù–∞ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ", "–ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–æ –∫ –ª–µ–Ω—Ç–µ", "–ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–æ –Ω–∞ –∑–∞–ø—Ä–∞–≤–∫—É", "–ï–¥–µ–º –≤ –ø—Ä—è–º–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏"],
    Purple: ["–í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –ø–∞—Ä–∫–æ–≤–∫—É –∏ –≥–∞—Ä–∞–∂"],
    Cyan: ["–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ", "–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–¥–∞—á–∏ –∑–∞–¥–Ω–µ–≥–æ —Ö–æ–¥–∞"],
    Brown: ["–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∫—Ä–∞—é –ø—Ä–æ–µ–∑–∂–µ–π —á–∞—Å—Ç–∏", "–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ –±–ª–∏–∂–∞–π—à–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–º –º–µ—Å—Ç–µ"],
    Lime: ["–ù–∞—á–∏–Ω–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ", "–ö–∞–∫ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –Ω–∞—á–∏–Ω–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ"]
};

let map, points = [], cur = null, isAdd = false, isDrawing = false, curGist = null, curFile = null, pend = { color: 'Gold', cmd: '', comm: '' };

const getSvg = (col, txt, az, isEnd) => {
    const s = isEnd ? 34 : 40, c = s/2;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}"><g transform="rotate(${az},${c},${c})"><polygon points="${c},2 ${s*0.75},${s-5} ${c},${s*0.65} ${s*0.25},${s-5}" fill="${col}" stroke="#000" stroke-width="1.5"/></g><circle cx="${c}" cy="${c}" r="${isEnd?7:9}" fill="${col}" stroke="#000" stroke-width="1"/><text x="${c}" y="${c+3}" font-size="10" font-family="Arial" font-weight="bold" text-anchor="middle" fill="#000" stroke="#fff" stroke-width="2.5" style="paint-order:stroke fill">${txt}</text></svg>`);
};

const updateCommandOptions = (selectId, colorName, currentValue = "") => {
    const select = $(selectId);
    select.innerHTML = '';
    const commands = COMMAND_SETS[colorName] || ["–ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã"];
    commands.forEach(cmd => {
        const opt = document.createElement('option');
        opt.value = cmd; opt.textContent = cmd;
        if(cmd === currentValue) opt.selected = true;
        select.appendChild(opt);
    });
};

ymaps.ready(() => {
    map = new ymaps.Map("map", { center: [56.3399, 43.9332], zoom: 17, type: 'yandex#satellite', controls: [] });
    map.events.add('click', e => { 
        if(isAdd) { 
            const p = addP(e.get('coords'), { color: pend.color, initialPath: { cmd: pend.cmd ? [pend.cmd] : [], comm: pend.comm } });
            startDrawingForPoint(p);
        } 
    });
    initD('newColorDropdown', 'newColorBtn', (h, n) => { pend.color = n; updateCommandOptions('newCmdSelect', n); });
    initD('editColorDropdown', 'editColorBtn', (h, n) => { if(cur) { cur.color = n; updateCommandOptions('editCmdSelect', n); applyChanges(); } });
    const t = localStorage.getItem('gh_t_gist');
    if(t) $('ghTokenWelcome').value = t;
});

// Gist API Core
const api = async (u, m = 'GET', b = null) => {
    const t = localStorage.getItem('gh_t_gist'); if(!t) return null;
    const headers = { Authorization: `token ${t}`, 'Content-Type': 'application/json' };
    try {
        const r = await fetch(u, { method: m, headers, body: b ? JSON.stringify(b) : null });
        if (m === 'DELETE' && r.status === 204) return true;
        return r.ok ? (r.status !== 204 ? r.json() : true) : null;
    } catch(e) { return null; }
};

// Welcome Logic
const showNewRouteInput = () => { 
    const t = $('ghTokenWelcome').value.trim();
    if(!t) return alert("–í–≤–µ–¥–∏—Ç–µ GitHub Token");
    localStorage.setItem('gh_t_gist', t);
    $('welcomeMain').style.display = 'none'; 
    $('newRouteForm').style.display = 'block'; 
};

const showGistList = async () => { 
    const t = $('ghTokenWelcome').value.trim();
    if(!t) return alert("–í–≤–µ–¥–∏—Ç–µ GitHub Token");
    localStorage.setItem('gh_t_gist', t);
    $('welcomeMain').style.display = 'none'; 
    $('editRouteList').style.display = 'block';
    await refreshGistList();
};

const refreshGistList = async () => {
    const listContainer = $('gistListContainer');
    listContainer.innerHTML = '<div style="padding:20px">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞...</div>';
    
    // –î–æ–±–∞–≤–ª—è–µ–º timestamp –∫ URL –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ API
    const gists = await api(`https://api.github.com/gists?t=${Date.now()}`);
    
    if(!gists) {
        listContainer.innerHTML = '<div style="padding:20px; color:red">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Token.</div>';
        return;
    }
    
    listContainer.innerHTML = '';
    let count = 0;
    gists.forEach(g => {
        Object.keys(g.files).forEach(fn => {
            if(fn.endsWith('.json')) {
                count++;
                const item = document.createElement('div');
                item.className = 'gist-item';
                item.innerHTML = `
                    <div class="gist-info" onclick="loadGist('${g.id}', '${fn}')">
                        <strong>${fn}</strong>
                        <small>${g.id.slice(0,8)} ‚Ä¢ ${new Date(g.updated_at).toLocaleTimeString()}</small>
                    </div>
                    <button class="btn-delete-file" onclick="handleFullDelete(event, '${g.id}', '${fn}')" title="–£–¥–∞–ª–∏—Ç—å Gist –ø–æ–ª–Ω–æ—Å—Ç—å—é">
                        üóëÔ∏è
                    </button>
                `;
                listContainer.appendChild(item);
            }
        });
    });
    if(!count) listContainer.innerHTML = '<div style="padding:20px">–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
};

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
const handleFullDelete = async (e, gistId, fileName) => {
    e.stopPropagation();
    if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç "${fileName}"?`)) return;
    
    const btn = e.currentTarget;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '‚è≥';

    try {
        const success = await api(`https://api.github.com/gists/${gistId}`, 'DELETE');
        
        if(success) {
            // –í–∞–∂–Ω–æ: –î–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É GitHub 300–º—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø–µ—Ä–µ–¥ —Ä–µ—Ñ—Ä–µ—à–µ–º
            setTimeout(async () => {
                await refreshGistList();
            }, 300);
        } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å Gist. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞.");
            btn.innerHTML = originalContent;
        }
    } catch (err) {
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.");
        btn.innerHTML = originalContent;
    }
};

const backToMain = () => { 
    $('newRouteForm').style.display = 'none'; 
    $('editRouteList').style.display = 'none'; 
    $('welcomeMain').style.display = 'block'; 
};

const initApp = () => { 
    $('welcomeScreen').style.display = 'none'; 
    $('map').style.display = 'block'; 
    $('bottomControls').style.display = 'flex'; 
};

const handleCreateNew = async () => {
    const n = $('newRouteName').value.trim();
    if(!n) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞");
    const fn = n + '.json';
    const r = await api('https://api.github.com/gists', 'POST', { public: true, files: { [fn]: { content: "[]" } } });
    if(r) { curGist = r.id; curFile = fn; initApp(); } else { alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞"); }
};

const initD = (did, bid, cb) => {
    const dr = $(did), bt = $(bid);
    Object.entries(COLORS).forEach(([n, d]) => {
        const r = Object.assign(document.createElement('div'), { className: 'color-row', onclick: (e) => { e.stopPropagation(); bt.style.background = d.hex; cb(d.hex, n); closeD(); } });
        r.innerHTML = `<div class="swatch" style="background:${d.hex}"></div><div class="color-label">${d.label}</div>`;
        dr.appendChild(r);
    });
};

const toggleD = id => { const d = $(id), vis = d.style.display === 'flex'; closeD(); if(!vis) { d.style.display = 'flex'; $('dropdownOverlay').style.display = 'block'; } };
const closeD = () => { document.querySelectorAll('.color-dropdown').forEach(dr => dr.style.display = 'none'); $('dropdownOverlay').style.display = 'none'; };
const toggleM = id => { const m = $(id); m.style.display = (m.style.display === 'none' || !m.style.display) ? 'flex' : 'none'; };

const handleAddBtnClick = () => {
    if(isDrawing) stopDrawingMode();
    else if(isAdd) stopAdd();
    else openCreateModal();
};

const openCreateModal = () => { $('newComm').value = ''; pend = { color: 'Gold', cmd: '', comm: '' }; $('newColorBtn').style.background = COLORS.Gold.hex; updateCommandOptions('newCmdSelect', 'Gold'); closeD(); toggleM('createPointModal'); };

const confirmP = () => { 
    pend.cmd = $('newCmdSelect').value; 
    pend.comm = $('newComm').value.trim(); 
    toggleM('createPointModal'); 
    isAdd = true; 
    $('addIcon').textContent = "‚úï"; 
    $('addText').textContent = "–û—Ç–º–µ–Ω–∞"; 
    $('addMarkerBtn').classList.add('active'); 
    map.setCursor('crosshair'); 
};

const stopAdd = () => { 
    isAdd = false; 
    $('addIcon').textContent = "+"; 
    $('addText').textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É"; 
    $('addMarkerBtn').classList.remove('active'); 
    map.setCursor('grab'); 
};

function addP(coords, data = null) {
    const p = { id: data?.id || (points.length + 1), lat: f6(coords[0]), lon: f6(coords[1]), az: data?.az || 0, color: data?.color || 'Gold', paths: [], pm: new ymaps.Placemark(coords, {}, { draggable: false, iconLayout: 'default#imageWithContent', iconImageSize: [40,40], iconImageOffset: [-20,-20], zIndex: 1000 }) };
    p.pm.geometry.events.add('change', () => {
        const nc = p.pm.geometry.getCoordinates(); p.lat = f6(nc[0]); p.lon = f6(nc[1]);
        p.paths.forEach(po => { if(po.line) { const pts = po.line.geometry.getCoordinates(); if(pts.length) { pts[0] = nc; po.line.geometry.setCoordinates(pts); if(pts.length >= 2) p.az = calcA(pts[0], pts[1]); } } });
        updI(p);
    });
    p.pm.events.add('click', () => { if(!isAdd && !isDrawing) openEdit(p); });
    map.geoObjects.add(p.pm); points.push(p); updI(p);
    if(data?.initialPath || !data?.id) { cur = p; addPath(data?.initialPath); }
    return p;
}

const startDrawingForPoint = p => {
    isAdd = false; isDrawing = true;
    $('addIcon').textContent = "‚úÖ"; $('addText').textContent = "–ó–∞–≤–µ—Ä—à–∏—Ç—å";
    $('addMarkerBtn').classList.remove('active'); $('addMarkerBtn').classList.add('drawing');
    cur = p; const line = cur.paths[0].line; line.editor.startDrawing(); 
    p.pm.options.set('draggable', true); line.editor.options.set('vertexDraggable', (idx) => idx !== 0);
};

const stopDrawingMode = () => { 
    if(!cur) return; 
    cur.pm.options.set('draggable', false); 
    if(cur.paths[0]?.line) { 
        cur.paths[0].line.editor.stopEditing(); 
        cur.paths[0].line.editor.options.set('vertexDraggable', true); 
    } 
    isDrawing = false;
    $('addIcon').textContent = "+"; $('addText').textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É"; 
    $('addMarkerBtn').classList.remove('drawing'); map.setCursor('grab'); cur = null; 
};

const openEdit = p => { cur = p; const pa = p.paths[0] || { cmd: [], comm: '' }; $('editTitle').textContent = `–ú–µ—Ç–∫–∞ #${p.id}`; $('editComm').value = pa.comm || ''; updateCommandOptions('editCmdSelect', p.color, pa.cmd?.[0] || ""); $('editColorBtn').style.background = COLORS[p.color].hex; closeD(); toggleM('editModal'); };
function applyChanges() { if(!cur) return; const pa = cur.paths[0]; if(pa) { pa.comm = $('editComm').value; const v = $('editCmdSelect').value; pa.cmd = v ? [v] : []; pa.line.options.set('strokeColor', COLORS[cur.color].hex); if(pa.pmEnd) updPI(pa, 1); } updI(cur); }

const startEditPath = () => { 
    const p = cur; toggleM('editModal'); isDrawing = true;
    $('addIcon').textContent = "‚úÖ"; $('addText').textContent = "–ó–∞–≤–µ—Ä—à–∏—Ç—å";
    $('addMarkerBtn').classList.add('drawing');
    p.pm.options.set('draggable', true); 
    if(p.paths[0]?.line) { p.paths[0].line.editor.startEditing(); p.paths[0].line.editor.options.set('vertexDraggable', (idx) => idx !== 0); } 
};

const delP = () => { if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return; points = points.filter(p => p !== cur); map.geoObjects.remove(cur.pm); cur.paths.forEach(pa => { map.geoObjects.remove(pa.line); if(pa.pmEnd) map.geoObjects.remove(pa.pmEnd); }); points.forEach((p, i) => { p.id = i+1; updI(p); }); toggleM('editModal'); cur = null; };

function addPath(data = null) {
    const sp = data?.pts ? data.pts[0] : [cur.lat, cur.lon], po = { cmd: data?.cmd || [], comm: data?.comm || '', az: data?.az || 0, pts: data?.pts || [sp], line: new ymaps.Polyline(data?.pts || [sp], {}, { strokeColor: COLORS[cur.color].hex, strokeWidth: 5, strokeOpacity: 0.8, zIndex: 500 }) };
    po.line.geometry.events.add('change', () => {
        const c = po.line.geometry.getCoordinates(); po.pts = c.map(pt => [f6(pt[0]), f6(pt[1])]);
        const o = points.find(p => p.paths.includes(po));
        if(o) { updPI(po, o.paths.indexOf(po) + 1); if(c.length && (f6(c[0][0]) !== o.lat || f6(c[0][1]) !== o.lon)) o.pm.geometry.setCoordinates(c[0]); if(c.length >= 2) { o.az = calcA(c[0], c[1]); updI(o); } }
    });
    map.geoObjects.add(po.line); cur.paths.push(po); if(data?.pts) updPI(po, cur.paths.length);
}

const updI = p => p.pm.options.set('iconImageHref', getSvg(COLORS[p.color].hex, p.id, p.az, false));
const calcA = (p1, p2) => Math.round((Math.atan2(Math.cos(Math.PI/180*p1[0])*(p2[1]-p1[1]), p2[0]-p1[0])*180/Math.PI+360)%360);

function updPI(po, num) {
    const pts = po.line.geometry.getCoordinates(); if(!pts.length) return;
    const last = pts[pts.length-1], prev = pts[pts.length-2]; po.az = prev ? calcA(prev, last) : 0;
    const o = points.find(p => p.paths.includes(po)), col = o ? COLORS[o.color].hex : '#000';
    if(!po.pmEnd) { po.pmEnd = new ymaps.Placemark(last, {}, { iconLayout: 'default#imageWithContent', iconImageSize: [34,34], iconImageOffset: [-17,-17], interactive: false, zIndex: 800 }); map.geoObjects.add(po.pmEnd); } else po.pmEnd.geometry.setCoordinates(last);
    po.pmEnd.options.set({ iconImageHref: getSvg(col, num, po.az, true) });
}

async function loadGist(id, fn) {
    const r = await api(`https://api.github.com/gists/${id}`); if(!r) return;
    const content = r.files[fn].content;
    let data = []; try { data = JSON.parse(content); } catch(e) { data = []; }
    points.forEach(p => { map.geoObjects.remove(p.pm); p.paths.forEach(pa => { map.geoObjects.remove(pa.line); if(pa.pmEnd) map.geoObjects.remove(pa.pmEnd); }); });
    points = []; curGist = id; curFile = fn;
    data.forEach((dp) => { 
        const p = addP([dp.lat, dp.lon], { id: dp.id, az: dp.az, color: dp.color }); 
        dp.paths.forEach(dpa => { cur = p; addPath(dpa); }); updI(p); 
    });
    if(points.length) map.setCenter([points[0].lat, points[0].lon]);
    initApp();
}

async function saveGist() {
    if(!curGist) return;
    const btn = $('saveBtn'), sIcon = $('saveIcon'), sText = $('saveText');
    btn.classList.add('loading'); sIcon.textContent = "‚è≥"; sText.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    const data = points.map(p => ({ id: p.id, lat: p.lat, lon: p.lon, az: p.az, color: p.color, paths: p.paths.map(pa => ({ pts: pa.pts, cmd: pa.cmd, comm: pa.comm || "", az: pa.az })) }));
    const success = await api(`https://api.github.com/gists/${curGist}`, 'PATCH', { files: { [curFile]: { content: JSON.stringify(data, null, 2) } } });
    btn.classList.remove('loading');
    if(success) {
        btn.classList.add('saved'); sIcon.textContent = "‚úÖ"; sText.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
        setTimeout(() => { btn.classList.remove('saved'); sIcon.textContent = "üíæ"; sText.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"; }, 2000);
    } else {
        sIcon.textContent = "‚ùå"; sText.textContent = "–û—à–∏–±–∫–∞";
        setTimeout(() => { sIcon.textContent = "üíæ"; sText.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"; }, 2000);
    }
}
</script>
</body>
</html>