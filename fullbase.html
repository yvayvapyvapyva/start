<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Route Editor Pro | V8</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU&suppressMapOpenBlock=true"></script>
    <style>
        :root { 
            --bg: #f5f5f7; 
            --btn: #007AFF; 
            --btn-txt: #fff;
            --sheet-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1d1d1f;
            --accent: #007AFF;
            --card-bg: #ffffff;
            --danger: #FF3B30;
            --success: #34C759;
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            overflow: hidden; background: #000; 
        }

        #map { position: absolute; inset: 0; z-index: 1; }
        [class*="-copyrights-pane"], [class*="-controls-pane"] { display: none !important; }

        /* Floating Controls */
        #togglePanelBtn { 
            position: absolute; bottom: 30px; right: 20px; z-index: 100; 
            width: 60px; height: 60px; border-radius: 50%; 
            background: var(--btn); color: white; border: none; 
            font-size: 24px; box-shadow: 0 8px 25px rgba(0,122,255,0.4);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        #finishDrawBtn { 
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%); 
            z-index: 2000; display: none; background: var(--success); color: white; 
            padding: 12px 24px; border-radius: 30px; font-weight: bold; border: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { transform: translate(-50%, -100%); } }

        /* Main Editor Panel (Sheet Style) */
        #mainPanel {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1500;
            background: var(--sheet-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 32px 32px 0 0; padding: 12px 20px 40px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh; overflow-y: auto;
        }
        #mainPanel.active { transform: translateY(0); }
        #mainPanel.hidden-state { transform: translateY(110%) !important; }

        .sheet-handle { 
            width: 40px; height: 5px; background: rgba(0,0,0,0.1); 
            border-radius: 3px; margin: 0 auto 15px; 
        }

        /* Tabs */
        .tabs-main { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { 
            flex: 1; padding: 12px; border: none; background: rgba(0,0,0,0.05); 
            border-radius: 12px; font-weight: 600; color: var(--text-main); 
            cursor: pointer; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--btn); color: white; }

        /* Path Tabs */
        #pathTabsContainer { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; 
            margin: 15px 0; scrollbar-width: none; 
        }
        #pathTabsContainer::-webkit-scrollbar { display: none; }
        .path-tab { 
            flex: 0 0 auto; padding: 10px 20px; background: white; 
            border: 1px solid rgba(0,0,0,0.1); border-radius: 14px; 
            font-size: 13px; font-weight: 700; cursor: pointer;
        }
        .path-tab.active { background: var(--btn); border-color: var(--btn); color: white; }
        .path-tab-add { border: 1px dashed var(--btn); color: var(--btn); }

        /* Forms */
        .row { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; }
        .card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05); }
        
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 12px; font-size: 14px; background: #fff; box-sizing: border-box;
        }

        .btn-action { 
            background: var(--btn); color: white; border: none; border-radius: 12px;
            padding: 12px 18px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;
        }
        .btn-action.sec { background: rgba(0,0,0,0.05); color: var(--text-main); }
        .btn-action.danger { background: var(--danger); }
        .btn-action:active { opacity: 0.7; }

        #currentColorBtn { 
            width: 44px; height: 44px; border-radius: 50%; border: 3px solid white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; 
        }

        #colorDropdown { 
            position: absolute; top: 70px; right: 20px; background: white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-radius: 20px; 
            padding: 12px; display: none; grid-template-columns: repeat(5, 1fr); 
            gap: 10px; z-index: 2000; border: 1px solid rgba(0,0,0,0.05); 
        }
        .swatch { width: 32px; height: 32px; border-radius: 8px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }

        .cmd-block { 
            background: #f9f9f9; padding: 10px; border-radius: 12px; 
            margin-bottom: 8px; border: 1px solid rgba(0,0,0,0.03);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
    </style>
</head>
<body>

<div id="map"></div>

<button id="togglePanelBtn" onclick="toggleMainPanel()">üõ†Ô∏è</button>
<button id="finishDrawBtn" onclick="toggleDraw()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ</button>

<div id="mainPanel">
    <div class="sheet-handle" onclick="toggleMainPanel()"></div>
    
    <div class="tabs-main">
        <button class="tab-btn active" id="btn-tab-point" onclick="switchTab('tab-point')">üìç –¢–æ—á–∫–∞</button>
        <button class="tab-btn" id="btn-tab-project" onclick="switchTab('tab-project')">üìÅ –ü—Ä–æ–µ–∫—Ç</button>
    </div>

    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ—á–∫–∏ -->
    <div id="tab-point" class="tab-content active">
        <div class="row" style="justify-content: space-between">
            <h2 id="pointIdDisplay" style="margin:0; font-size: 22px; letter-spacing: -0.5px">–¢–æ—á–∫–∞ #...</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn-action danger" onclick="delPoint()" style="padding: 10px; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">üóëÔ∏è</button>
                <div style="position: relative">
                    <div id="currentColorBtn" onclick="toggleColorDropdown()"></div>
                    <div id="colorDropdown"></div>
                </div>
            </div>
        </div>

        <div id="pathTabsContainer"></div>

        <div id="pathEditor" style="display:none;">
            <div class="card">
                <div class="row">
                    <button class="btn-action" onclick="toggleDraw()" style="flex: 2;">üõ§Ô∏è –†–∏—Å–æ–≤–∞—Ç—å –ø—É—Ç—å</button>
                    <button class="btn-action sec" onclick="addCmdRow()" style="flex: 2;">+ –§—Ä–∞–∑–∞</button>
                    <button class="btn-action danger" onclick="delPath()" style="flex: 0.6;">üóëÔ∏è –ü.</button>
                </div>
                
                <div id="cmdsContainer" style="margin-top: 10px;"></div>
                
                <textarea id="pathComm" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —ç—Ç–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É –º–∞—Ä—à—Ä—É—Ç–∞..." style="height: 80px; margin-top: 10px;" onblur="saveFields()"></textarea>
            </div>
        </div>
        
        <div id="noPathHint" style="text-align: center; padding: 40px 20px; color: #888;">
            –ù–∞–∂–º–∏—Ç–µ <b>+ –ü—É—Ç—å</b>, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ–µ–∑–¥–∞
        </div>
    </div>

    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div id="tab-project" class="tab-content">
        <div class="card">
            <label style="font-size: 12px; font-weight: 600; color: #888; margin-bottom: 5px; display: block;">GitHub Token</label>
            <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx" oninput="saveToken(this.value)">
            
            <div class="row" style="margin-top:15px">
                <select id="fileSelector" onchange="loadFromGH(this.value)">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑ –ø–∞–ø–∫–∏ /roads...</option>
                </select>
                <button class="btn-action" style="flex:0 0 50px;" onclick="createFile()">+</button>
            </div>
        </div>

        <div class="row">
            <button class="btn-action" style="flex:1; background: var(--success)" onclick="saveToGH()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>

        <div class="row">
            <button class="btn-action sec" style="flex:1" onclick="exportJSON()">üìé –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        </div>
    </div>
</div>

<script>
const REPO = "yvayvapyvapyva/test", PATH = "roads", f6 = n => Math.round(n * 1e6) / 1e6;
const COLORS = { Gold: '#FFD700', Blue: '#0070FF', Red: '#FF0000', Lime: '#34C759', Fuchsia: '#AF52DE', Orange: '#FF9500', Purple: '#5856D6', Cyan: '#5AC8FA', Brown: '#A2845E', Grey: '#8E8E93' };

const PRESETS = [
    "üìù", 
    "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ", 
    "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–µ–¥–µ–º –ø—Ä—è–º–æ", 
    "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ", 
    "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç", 
    "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã–π —Å—ä–µ–∑–¥", 
    "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π —Å—ä–µ–∑–¥", 
    "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç—Ä–µ—Ç–∏–π —Å—ä–µ–∑–¥", 
    "–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—ä–µ–∑–¥", 
    "–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞", 
    "–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º –º–µ—Å—Ç–µ", 
    "–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ", 
    "–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ", 
    "–ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å", 
    "–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∫—Ä–∞—é –ø—Ä–æ–µ–∑–∂–µ–π —á–∞—Å—Ç–∏", 
    "–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏", 
    "–ù–∞–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—á–∞—Å—Ç–∫–µ –¥–æ—Ä–æ–≥–∏", 
    "–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ", 
    "–í—ã–ø–æ–ª–Ω–∏–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ"
];

let map, points = [], cur = null, curPathIdx = -1, sha = null, selPath = null;

const getSvg = (col, txt, az, isEnd) => {
    const s = isEnd ? 34 : 40, c = s/2;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}"><g transform="rotate(${az},${c},${c})"><polygon points="${c},2 ${s*0.75},${s-5} ${c},${s*0.65} ${s*0.25},${s-5}" fill="${col}" stroke="${isEnd?'#fff':'#000'}" stroke-width="2"/></g><circle cx="${c}" cy="${c}" r="${isEnd?7:9}" fill="${col}" stroke="${isEnd?'#fff':'#000'}" stroke-width="1"/><text x="${c}" y="${c+3}" font-size="${isEnd?9:10}" font-family="Arial" font-weight="bold" text-anchor="middle" fill="#000" stroke="#fff" stroke-width="3" style="paint-order:stroke fill">${txt}</text></svg>`);
};

ymaps.ready(() => {
    map = new ymaps.Map("map", { 
        center: [56.3399, 43.9332], zoom: 17, 
        type: 'yandex#satellite', controls: [] 
    }, { suppressMapOpenBlock: true });

    map.events.add('click', e => { 
        if(!e.get('target').geometry) { 
            selectPoint(addPoint(e.get('coords'))); 
        } 
    });

    const drop = document.getElementById('colorDropdown');
    Object.entries(COLORS).forEach(([name, hex]) => {
        const d = document.createElement('div'); d.className = 'swatch'; d.style.background = hex;
        d.onclick = () => { 
            if(cur) { 
                cur.color = name; updateIcon(cur); 
                cur.paths.forEach((p,i) => { p.line.options.set('strokeColor', hex); updatePathIcon(p, i+1); }); 
            } 
            drop.style.display = 'none'; 
        };
        drop.appendChild(d);
    });

    const t = localStorage.getItem('gh_t'); 
    if(t) { document.getElementById('ghToken').value = t; listFiles(); }
});

function addPoint(coords) {
    const p = { 
        id: points.length + 1, lat: f6(coords[0]), lon: f6(coords[1]), az: 0, 
        color: 'Gold', paths: [], 
        pm: new ymaps.Placemark(coords, {}, { 
            draggable: true, 
            iconLayout: 'default#imageWithContent', iconImageSize: [40,40], iconImageOffset: [-20,-20] 
        }) 
    };
    p.pm.events.add('drag', () => {
        const c = p.pm.geometry.getCoordinates(); [p.lat, p.lon] = [f6(c[0]), f6(c[1])];
        p.paths.forEach((po, i) => { if(po.line) { let pts = po.line.geometry.getCoordinates(); pts[0] = c; po.line.geometry.setCoordinates(pts); updatePathIcon(po, i+1); } });
        syncAz(p);
    }).add('click', () => selectPoint(p));
    map.geoObjects.add(p.pm); points.push(p); updateIcon(p); return p;
}

function selectPoint(p) {
    if(cur && curPathIdx !== -1) cur.paths[curPathIdx].line.editor.stopEditing();
    points.forEach(pt => { 
        pt.paths.forEach(po => { po.line.options.set('visible', false); if(po.pmEnd) po.pmEnd.options.set('visible', false); }); 
    });
    cur = p; curPathIdx = -1;
    if(p) {
        document.getElementById('mainPanel').classList.add('active');
        document.getElementById('pointIdDisplay').textContent = "–¢–æ—á–∫–∞ #" + p.id;
        document.getElementById('currentColorBtn').style.background = COLORS[p.color];
        p.paths.forEach(po => { po.line.options.set('visible', true); if(po.pmEnd) po.pmEnd.options.set('visible', true); updatePathIcon(po, p.paths.indexOf(po) + 1); });
        renderTabs(); 
        if(p.paths.length) selectPath(0); 
        else {
            document.getElementById('pathEditor').style.display='none';
            document.getElementById('noPathHint').style.display='block';
        }
    } else {
        document.getElementById('mainPanel').classList.remove('active');
    }
}

function selectPath(idx) {
    curPathIdx = idx; const p = cur.paths[idx];
    document.getElementById('pathEditor').style.display = idx===-1?'none':'block';
    document.getElementById('noPathHint').style.display = idx===-1?'block':'none';
    if(p) {
        document.getElementById('pathComm').value = p.comm || '';
        document.getElementById('cmdsContainer').innerHTML = '';
        (p.cmd || []).forEach(c => addCmdRow(c));
    }
    renderTabs();
}

function addNewPath() {
    const po = { cmd: [], comm: '', az: 0, pts: [[cur.lat, cur.lon]], line: new ymaps.Polyline([[cur.lat, cur.lon]], {}, { strokeColor: COLORS[cur.color], strokeWidth: 5, strokeOpacity: 0.8 }) };
    setupLine(po, cur.paths.length + 1);
    map.geoObjects.add(po.line); cur.paths.push(po); selectPath(cur.paths.length-1);
}

function addCmdRow(val = "") {
    const b = document.createElement('div'); b.className = 'cmd-block';
    b.innerHTML = `
        <div style="display:flex; gap:8px">
            <select style="flex:0 0 50px">${PRESETS.map(p=>`<option value="${p==='üìù'?'':p}">${p}</option>`).join('')}</select>
            <input class="ci" value="${val}" placeholder="–¢–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã...">
            <button onclick="this.parentElement.parentElement.remove(); saveFields();" style="background:none; border:none; color:var(--danger); font-size:20px; cursor:pointer">&times;</button>
        </div>`;
    const s = b.querySelector('select'), i = b.querySelector('.ci');
    s.onchange = () => { if(s.value) { i.value = s.value; saveFields(); s.selectedIndex = 0; } };
    i.onblur = saveFields;
    document.getElementById('cmdsContainer').appendChild(b);
}

function toggleDraw() {
    const po = cur.paths[curPathIdx], ed = po.line.editor;
    const isEd = ed.state.get('editing');
    if(!isEd) ed.startDrawing(); else ed.stopEditing();
    document.getElementById('mainPanel').classList.toggle('hidden-state', !isEd);
    document.getElementById('finishDrawBtn').style.display = !isEd ? 'block' : 'none';
}

function updateIcon(p) { p.pm.options.set('iconImageHref', getSvg(COLORS[p.color], p.id, p.az, false)); if(cur===p) document.getElementById('currentColorBtn').style.background = COLORS[p.color]; }
function updatePathIcon(po, num) {
    const pts = po.line.geometry.getCoordinates(); if(!pts.length) return;
    const last = pts[pts.length-1], prev = pts[pts.length-2];
    po.az = prev ? calcAngle(prev, last) : 0;
    if(!po.pmEnd) {
        po.pmEnd = new ymaps.Placemark(last, {}, { iconLayout: 'default#imageWithContent', iconImageSize: [34,34], iconImageOffset: [-17,-17], interactive: false });
        map.geoObjects.add(po.pmEnd);
    } else po.pmEnd.geometry.setCoordinates(last);
    po.pmEnd.options.set({ iconImageHref: getSvg(COLORS[cur.color], num, po.az, true), visible: po.line.options.get('visible') });
}

function setupLine(po, num) {
    po.line.geometry.events.add('change', () => {
        po.pts = po.line.geometry.getCoordinates().map(c => [f6(c[0]), f6(c[1])]);
        updatePathIcon(po, num); syncAz(cur);
    });
}

function renderTabs() {
    const c = document.getElementById('pathTabsContainer'); c.innerHTML = ''; if(!cur) return;
    cur.paths.forEach((_, i) => {
        const t = document.createElement('div'); t.className = `path-tab ${curPathIdx===i?'active':''}`;
        t.textContent = `–í–∞—Ä–∏–∞–Ω—Ç ${i+1}`; t.onclick = () => selectPath(i); c.appendChild(t);
    });
    const b = document.createElement('div'); b.className = 'path-tab path-tab-add'; b.textContent = '+ –ü—É—Ç—å'; b.onclick = addNewPath; c.appendChild(b);
}

function saveFields() { if(cur && curPathIdx!==-1) { const p = cur.paths[curPathIdx]; p.cmd = Array.from(document.querySelectorAll('.ci')).map(i=>i.value.trim()).filter(v=>v); p.comm = document.getElementById('pathComm').value.trim(); } }
function toggleMainPanel() { document.getElementById('mainPanel').classList.toggle('active'); }
function toggleColorDropdown() { const d = document.getElementById('colorDropdown'); d.style.display = d.style.display==='grid'?'none':'grid'; }
function switchTab(id) { 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id.includes(id))); 
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id===id)); 
}
const calcAngle = (p1, p2) => {
    const dy = p2[0]-p1[0], dx = Math.cos(Math.PI/180*p1[0])*(p2[1]-p1[1]);
    return Math.round((Math.atan2(dx, dy)*180/Math.PI+360)%360);
};
function syncAz(p) { if(p.paths[0]?.line) { const c = p.paths[0].line.geometry.getCoordinates(); if(c.length>=2) { p.az = calcAngle(c[0], c[1]); updateIcon(p); } } }

function getCleanData() {
    saveFields();
    return points.map((p, i) => ({
        id: i + 1,
        lat: p.lat,
        lon: p.lon,
        az: p.az,
        color: p.color,
        paths: p.paths.map(pa => {
            let finalCmd = [...(pa.cmd || [])];
            if (finalCmd.length === 0) {
                if (p.color === 'Red') finalCmd = ["–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏", "–ù–∞–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—á–∞—Å—Ç–∫–µ –¥–æ—Ä–æ–≥–∏"];
                if (p.color === 'Blue') finalCmd = ["–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞", "–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º –º–µ—Å—Ç–µ"];
            }

            const item = { pts: pa.pts };
            if (finalCmd.length > 0) item.cmd = finalCmd;
            if (pa.comm && pa.comm.trim()) item.comm = pa.comm.trim();
            if (pa.az) item.az = pa.az;
            
            return item;
        })
    }));
}

function delPoint() {
    if(!cur) return;
    if(cur.paths) {
        cur.paths.forEach(p=>{ 
            if(p.line) map.geoObjects.remove(p.line); 
            if(p.pmEnd) map.geoObjects.remove(p.pmEnd); 
        });
    }
    map.geoObjects.remove(cur.pm); 
    points = points.filter(p=>p!==cur);
    points.forEach((p, i) => { p.id = i+1; updateIcon(p); }); 
    selectPoint(null);
}

function delPath() {
    if(curPathIdx===-1) return;
    const p = cur.paths[curPathIdx];
    map.geoObjects.remove(p.line); if(p.pmEnd) map.geoObjects.remove(p.pmEnd);
    cur.paths.splice(curPathIdx,1); syncAz(cur); selectPath(cur.paths.length?0:-1);
}

function stringify(data) { 
    return JSON.stringify(data, (key, value) => {
        if (key === 'pts' && Array.isArray(value)) {
            return `__PTS_START__${JSON.stringify(value)}__PTS_END__`;
        }
        return value;
    }, 2).replace(/"__PTS_START__(.*?)__PTS_END__"/g, '$1');
}

function exportJSON() { const b = new Blob([stringify(getCleanData())], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'roads.json'; a.click(); }

function render(json) {
    points.forEach(p => { p.paths.forEach(pa => { if(pa.line) map.geoObjects.remove(pa.line); if(pa.pmEnd) map.geoObjects.remove(pa.pmEnd); }); map.geoObjects.remove(p.pm); });
    points = []; 
    json.forEach((d, idx) => {
        const p = addPoint([d.lat, d.lon]); 
        p.id = idx + 1; p.az = d.az; p.color = d.color || 'Gold';
        p.paths = (d.paths || []).map((pa, i) => {
            const po = { ...pa, line: new ymaps.Polyline(pa.pts, {}, { strokeColor: COLORS[p.color], strokeWidth: 5, strokeOpacity: 0.8, visible: false }) };
            setupLine(po, i + 1); map.geoObjects.add(po.line); return po;
        });
        updateIcon(p);
    });
    selectPoint(null);
}

// GitHub API
const api = (u, m='GET', b=null) => fetch(`https://api.github.com/repos/${REPO}/${u}`, { method: m, headers: { Authorization: `token ${document.getElementById('ghToken').value}` }, body: b ? JSON.stringify(b) : null }).then(r => r.json());
async function listFiles() { const t = document.getElementById('ghToken').value; if(!t) return; const files = await api(`contents/${PATH}`); const sel = document.getElementById('fileSelector'); sel.innerHTML = '<option value="">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª...</option>'; if(files.length) files.filter(f => f.name.endsWith('.json')).forEach(f => { const o = document.createElement('option'); o.value = f.path; o.textContent = f.name; sel.appendChild(o); }); }
async function loadFromGH(p) { if(!p) return; const d = await api(`contents/${p}`); sha = d.sha; selPath = p; render(JSON.parse(decodeURIComponent(escape(atob(d.content))))); }
async function saveToGH() { if(!selPath) return alert("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω"); const content = btoa(unescape(encodeURIComponent(stringify(getCleanData())))); const res = await api(`contents/${selPath}`, 'PUT', { message: 'upd', content, sha }); if(res.content) { sha = res.content.sha; alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); } }
function saveToken(v) { localStorage.setItem('gh_t', v); if(v.length > 20) listFiles(); }
async function createFile() { let n = prompt("–ò–º—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞:"); if(n) { await api(`contents/${PATH}/${n.endsWith('.json')?n:n+'.json'}`, 'PUT', { message: 'new', content: btoa("[]") }); listFiles(); } }
</script>
</body>
</html>
